# Структура моделей модуля dino_erp_stock

## Обзор

Модуль dino_erp_stock реализует иерархическую систему управления складской номенклатурой, где:
- **Категории** группируют компоненты
- **Компоненты (Семейства)** объединяют схожие товары
- **Номенклатура (Исполнения)** представляет конкретные варианты товаров
- **Спецификации (BOM)** описывают состав изделий
- **Параметры** хранят технические характеристики

---

## 1. Категория продукции (`product.category`)

**Расширение стандартной модели Odoo**

### Назначение
Группировка компонентов по типам (материалы, комплектующие, услуги и т.д.) с настройкой видимости спецификаций и типа происхождения.

### Основные поля

| Поле | Тип | Описание |
|------|-----|----------|
| `hide_specification` | Boolean | Скрывает вкладку "Спецификация" для данной категории |
| `origin_type` | Selection | Тип происхождения: `purchase` (Закупка), `subcontract` (Субподряд), `service` (Услуга), `production` (Производство) |
| `dino_component_count` | Integer (computed) | Количество семейств компонентов в категории |
| `dino_nomenclature_count` | Integer (computed) | Количество номенклатурных позиций в категории |

### Методы

- `_compute_dino_counts()` — расчет количества компонентов и номенклатур (включая дочерние категории)
- `action_view_dino_components()` — открытие списка семейств компонентов
- `action_view_dino_nomenclatures()` — открытие списка номенклатур

### Связи
- → `dino.component` (One2many через `category_id`)

---

## 2. Компонент / Семейство (`dino.component`)

**Базовая модель**

### Назначение
Группа однотипных товаров (например, "Винт М4", "Ручка дверная"), объединяющая различные исполнения.

### Основные поля

| Поле | Тип | Описание |
|------|-----|----------|
| `name` | Char | Название семейства (например, "Винт М4"), уникальное, с переводом |
| `active` | Boolean | Активность записи |
| `category_id` | Many2one | Категория продукции (`product.category`) |
| `uom_id` | Many2one | Единица измерения (`uom.uom`) |
| `nomenclature_ids` | One2many | Список исполнений этого семейства |
| `nomenclature_count` | Integer (computed) | Количество исполнений |
| `description` | Html | Внутренние заметки |
| `is_favorite` | Boolean | Избранное |
| `image_1920` | Binary | Изображение (через `image.mixin`) |

### Методы

- `_compute_nomenclature_count()` — подсчет количества исполнений
- `action_view_nomenclatures()` — открытие списка исполнений данного семейства
- `toggle_is_favorite()` — переключение флага "Избранное"

### Связи
- ← `product.category` (Many2one)
- → `dino.nomenclature` (One2many через `component_id`)

### Ограничения
- Уникальность названия семейства (`name_uniq`)

---

## 3. Номенклатура / Исполнение (`dino.nomenclature`)

**Основная модель складского учета**

### Назначение
Конкретный вариант товара с уникальными характеристиками (например, "Винт М4 12 мм", "Ручка дверная 810 мм оцинкованная").

### Основные поля

| Поле | Тип | Описание |
|------|-----|----------|
| `component_id` | Many2one | Родительское семейство (обязательно) |
| `name` | Char | Название исполнения (суффикс, например "810 мм") |
| `fullname` | Char (computed) | Полное имя = Семейство + Суффикс |
| `code` | Char | Артикул / код детали |
| `active` | Boolean | Активность записи |
| `category_id` | Many2one (related) | Категория (из родителя) |
| `uom_id` | Many2one (related) | Единица измерения (из родителя) |
| `hide_specification` | Boolean (related) | Скрыть спецификацию (из категории) |
| `origin_type` | Selection (related) | Тип происхождения (из категории) |
| `currency_id` | Many2one | Валюта (по умолчанию валюта компании) |
| `cost` | Monetary | Себестоимость |
| `qty_available` | Float | Количество на складе |
| `material_cost` | Monetary (computed) | Стоимость материалов (сумма BOM) |
| `parameter_ids` | One2many | Технические параметры |
| `bom_line_ids` | One2many | Строки спецификации (BOM) |
| `purpose` | Char | Назначение (краткое описание) |
| `description` | Html | Внутренние заметки |

### Методы

- `_compute_fullname()` — автоматическая склейка полного имени
- `_compute_material_cost()` — расчет стоимости материалов по BOM
- `action_open_form()` — открытие формы номенклатуры
- `_compute_display_name()` — управление отображением имени (полное/краткое) в зависимости от контекста

### Связи
- ← `dino.component` (Many2one)
- → `dino.parameter` (One2many через `nomenclature_id`)
- → `dino.bom.line` (One2many через `parent_nomenclature_id`)
- ↔ `dino.bom.line` (Many2many обратная связь через `nomenclature_ids`)

### Наследование
- `mail.thread` — отслеживание изменений
- `mail.activity.mixin` — планирование активностей

---

## 4. Строка спецификации / BOM (`dino.bom.line`)

**Модель состава изделия**

### Назначение
Определяет, из каких компонентов состоит конкретное исполнение номенклатуры и в каком количестве.

### Основные поля

| Поле | Тип | Описание |
|------|-----|----------|
| `parent_nomenclature_id` | Many2one | Владелец спецификации (обязательно) |
| `component_id` | Many2one | Семейство компонента (обязательно) |
| `nomenclature_ids` | Many2many | Конкретные исполнения/аналоги |
| `qty` | Float | Количество (по умолчанию 1.0) |
| `sequence` | Integer | Порядок сортировки |
| `currency_id` | Many2one (related) | Валюта (из родителя) |
| `cost` | Monetary (computed) | Средняя цена выбранных исполнений |
| `total_cost` | Monetary (computed) | Итоговая стоимость = qty × cost |

### Методы

- `_compute_cost()` — расчет средней цены по выбранным аналогам
- `_compute_total_cost()` — расчет итоговой стоимости строки
- `action_open_analogs()` — открытие формы/списка выбранных аналогов

### Связи
- ← `dino.nomenclature` (Many2one как родитель)
- ← `dino.component` (Many2one для выбора семейства)
- ↔ `dino.nomenclature` (Many2many для выбора исполнений)

### Логика работы
1. Пользователь выбирает семейство (`component_id`)
2. Система фильтрует доступные исполнения по этому семейству
3. Пользователь выбирает одно или несколько исполнений (`nomenclature_ids`)
4. Система вычисляет среднюю цену и итоговую стоимость

---

## 5. Параметр (`dino.parameter`)

**Модель технических характеристик**

### Назначение
Хранение технических параметров номенклатуры (длина, ширина, вес, мощность и т.д.).

### Основные поля

| Поле | Тип | Описание |
|------|-----|----------|
| `nomenclature_id` | Many2one | Принадлежность к номенклатуре (обязательно) |
| `name` | Char | Название параметра (например, "Длина") |
| `value` | Float | Значение параметра (например, 810) |
| `uom_id` | Many2one | Единица измерения (например, "мм") |
| `sequence` | Integer | Порядок сортировки |

### Связи
- ← `dino.nomenclature` (Many2one)
- ← `uom.uom` (Many2one)

---

## Диаграмма связей

```
product.category (Категория)
    ↓ category_id
dino.component (Семейство)
    ↓ component_id
dino.nomenclature (Исполнение)
    ↓ nomenclature_id           ↓ parent_nomenclature_id
dino.parameter               dino.bom.line
                                ↓ nomenclature_ids (Many2many)
                            dino.nomenclature
```

---

## Примеры использования

### Пример 1: Простой компонент без BOM

**Категория:** Крепеж  
**Семейство:** Винт М4  
**Исполнение:** Винт М4 12 мм  
**Параметры:**
- Длина: 12 мм
- Диаметр: 4 мм
- Материал: Сталь

**BOM:** отсутствует (закупается готовым)

### Пример 2: Сложное изделие с BOM

**Категория:** Фурнитура  
**Семейство:** Комплект ручек  
**Исполнение:** Комплект ручек 810 мм оцинкованный  
**Параметры:**
- Длина: 810 мм
- Покрытие: Оцинкованный

**BOM:**
| Семейство | Исполнения | Количество | Цена | Сумма |
|-----------|-----------|------------|------|-------|
| Ручка | Ручка 810 мм | 2 | 50.00 | 100.00 |
| Винт М4 | Винт М4 12 мм, Винт М4 14 мм | 8 | 0.50 | 4.00 |
| **Итого материалы:** | | | | **104.00** |

---

## Особенности реализации

### 1. Вычисляемые поля
- Используются `@api.depends` для автоматического пересчета
- `store=True` для кэширования часто используемых значений

### 2. Связанные поля (related)
- Упрощают доступ к полям родительских объектов
- Автоматически синхронизируются

### 3. Контекстная логика
- `show_short_name` в `_compute_display_name()` позволяет показывать краткое имя

### 4. Каскадное удаление
- `ondelete='cascade'` обеспечивает целостность данных

### 5. Многоязычность
- `translate=True` для полей с текстом
- Поддержка i18n (ru, uk)

### 6. Аудит изменений
- `mail.thread` для отслеживания истории
- `tracking=True` на ключевых полях

---

## Расширения модуля (www/)

В каталоге `www/` находятся дополнительные модели и расширения:

- `product_component.py` — расширение стандартных продуктов Odoo
- `product_component_attribute.py` — атрибуты компонентов
- `product_component_bom.py` — интеграция с BOM Odoo

Эти файлы обеспечивают совместимость с базовым функционалом Odoo и могут использоваться для интеграции с другими модулями.

---

**Дата документа:** 5 декабря 2025 г.  
**Версия модуля:** 19.0  
**Автор:** Revent24
